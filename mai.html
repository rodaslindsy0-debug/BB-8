<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>BB-8 Registro M√©dico</title>

<!-- Favicon -->
<link rel="icon" href="https://upload.wikimedia.org/wikipedia/commons/3/39/BB-8_Star_Wars_icon.png" type="image/png">

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, getDoc, doc, orderBy, query, writeBatch, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// Config Firebase
const firebaseConfig = {
  apiKey: "AIzaSyDH-Ii_v4nHkBv1-0exU7kvyrcK-vf0SnU",
  authDomain: "maicol-114de.firebaseapp.com",
  projectId: "maicol-114de",
  storageBucket: "maicol-114de.firebasestorage.app",
  messagingSenderId: "770237885252",
  appId: "1:770237885252:web:a4d98332eb4c74a4f30511",
  measurementId: "G-Z8V3X8W8G1"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const provider = new GoogleAuthProvider();

const loginDiv = document.getElementById('login');
const appDiv = document.getElementById('app');
const googleBtn = document.getElementById('googleBtn');
const loginEmailBtn = document.getElementById('loginEmail');
const registerBtn = document.getElementById('registerEmail');
const logoutBtn = document.getElementById('logout');
const userNameEl = document.getElementById('userName');
const userEmailEl = document.getElementById('userEmail');
const navReg = document.getElementById('navReg');
const navHist = document.getElementById('navHist');
const regPanel = document.getElementById('regPanel');
const histPanel = document.getElementById('histPanel');
const historyList = document.getElementById('historyList');
const dateInput = document.getElementById('dateInput');
const timeInput = document.getElementById('timeInput');
const oxygenInput = document.getElementById('oxygenInput');
const pulseInput = document.getElementById('pulseInput');
const saveEntryBtn = document.getElementById('saveEntry');
const btnNow = document.getElementById('btnNow');
const exportBtn = document.getElementById('exportBtn');
const clearBtn = document.getElementById('clearBtn');

let currentUser = null;

// Mensajes
function showMessage(msg, color='red'){
  let div = document.createElement('div');
  div.textContent = msg;
  div.style.position = 'fixed';
  div.style.bottom = '20px';
  div.style.left = '50%';
  div.style.transform = 'translateX(-50%)';
  div.style.background = color==='red' ? 'rgba(255,60,60,0.9)' : 'rgba(0,180,0,0.9)';
  div.style.color = 'white';
  div.style.padding = '12px 18px';
  div.style.borderRadius = '8px';
  div.style.fontWeight = '600';
  div.style.zIndex = '9999';
  document.body.appendChild(div);
  setTimeout(()=> div.remove(), 5000);
}

// Mostrar app / login
function showApp(user){
  loginDiv.style.display='none';
  appDiv.style.display='flex';
  userNameEl.textContent = user.displayName || user.email.split('@')[0];
  userEmailEl.textContent = user.email;
  currentUser = user;
  loadHistory();
}
function showLogin(){
  loginDiv.style.display='flex';
  appDiv.style.display='none';
  currentUser = null;
}

// Auth state
onAuthStateChanged(auth, user => {
  if(user) showApp(user);
  else showLogin();
});

// Google login
googleBtn.addEventListener('click', async ()=>{
  try{
    await signInWithPopup(auth, provider);
  }catch(e){ showMessage("Error Google login: "+e.message); }
});

// Email login
loginEmailBtn.addEventListener('click', async ()=>{
  let email = document.getElementById('emailInput').value.trim();
  const pass  = document.getElementById('passInput').value;

  if(!email || !pass){ showMessage("Ingresa correo y contrase√±a"); return; }

  const emailRegex = /^[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$/i;
  if(!emailRegex.test(email)){
    showMessage("Correo electr√≥nico inv√°lido");
    return;
  }

  email = email.toLowerCase();
  if(!email.endsWith("@gmail.com")){
    showMessage("Debes usar un correo Gmail v√°lido");
    return;
  }

  try{
    await signInWithEmailAndPassword(auth, email, pass);
  }catch(e){
    if(e.code === 'auth/user-not-found') showMessage("No existe una cuenta con este correo");
    else if(e.code === 'auth/wrong-password') showMessage("Contrase√±a incorrecta");
    else showMessage("Error login: "+e.message);
  }
});

// Email register
registerBtn.addEventListener('click', async ()=>{

  let firstName = document.getElementById('firstNameInput').value.trim();
  let lastName  = document.getElementById('lastNameInput').value.trim();
  let age       = document.getElementById('ageInput').value.trim();
  let contact   = document.getElementById('contactInput').value.trim();
  let email     = document.getElementById('emailInput').value.trim();
  const pass    = document.getElementById('passInput').value;

  if(!firstName || !lastName || !age || !contact || !email || !pass){
    showMessage("Completa todos los campos");
    return;
  }

  const emailRegex = /^[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$/i;
  if(!emailRegex.test(email)){
    showMessage("Correo electr√≥nico inv√°lido");
    return;
  }

  email = email.toLowerCase();
  if(!email.endsWith("@gmail.com")){
    showMessage("Debes usar un correo Gmail v√°lido");
    return;
  }

  try{
    const userCredential = await createUserWithEmailAndPassword(auth, email, pass);
    const user = userCredential.user;

    // üîπ Generar el link para el contacto
    const permissionLink = `https://rodaslindsy0-debug.github.io/BB-8/2.html?contact=${contact}`;

    // üîπ Guardar datos en Firestore
    await addDoc(collection(db,'users',user.uid,'profile'), {
      firstName,
      lastName,
      age: parseInt(age),
      contact,
      permissionLink,
      createdAt: serverTimestamp()
    });

    showMessage("Usuario creado con √©xito!", 'green');

    // üîπ Mostrar el link listo para copiar
    alert("Copia y env√≠a este link al contacto de emergencia:\n\n" + permissionLink);

    console.log("üîó Link de emergencia: ", permissionLink);

  }catch(e){
    if(e.code === 'auth/email-already-in-use') showMessage("Correo ya registrado");
    else if(e.code === 'auth/weak-password') showMessage("Contrase√±a demasiado d√©bil (m√≠nimo 6 caracteres)");
    else showMessage("Error registro: "+e.message);
  }
});

// Logout
logoutBtn.addEventListener('click', ()=> signOut(auth));

// Navegaci√≥n
navReg.addEventListener('click', ()=>{ 
  regPanel.style.display='block'; 
  histPanel.style.display='none'; 
  document.getElementById("shareLink").value = generateShareLink();
});
navHist.addEventListener('click', ()=>{ regPanel.style.display='none'; histPanel.style.display='block'; });

// Hora actual
btnNow.addEventListener('click', ()=>{
  const now = new Date();
  dateInput.value = now.toISOString().slice(0,10);
  timeInput.value = now.toTimeString().slice(0,5);
});

/* --- ENVIAR NOTIFICACIONES PUSH - CORREGIDO --- */
async function sendEmergencyNotification(oxygen, pulse) {
  try {
    console.log("üîç Buscando perfil del usuario...");
    
    // 1. Obtener el n√∫mero de contacto del perfil del usuario
    const profileQuery = query(collection(db, 'users', currentUser.uid, 'profile'));
    const profileSnapshot = await getDocs(profileQuery);
    
    if (profileSnapshot.empty) {
      console.log("‚ùå No se encontr√≥ perfil del usuario");
      showMessage("No se encontr√≥ informaci√≥n del perfil", 'red');
      return;
    }
    
    const profileData = profileSnapshot.docs[0].data();
    const contactNumber = profileData.contact;
    
    if (!contactNumber) {
      console.log("‚ùå No hay n√∫mero de contacto registrado");
      showMessage("No hay n√∫mero de contacto registrado", 'red');
      return;
    }
    
    console.log("üìû N√∫mero de contacto encontrado:", contactNumber);
    
    // 2. Buscar el token FCM usando el N√öMERO de contacto (no el user ID)
    const contactRef = doc(db, "contacts", contactNumber);
    const contactDoc = await getDoc(contactRef);
    
    if (!contactDoc.exists()) {
      console.log("‚ùå El contacto no ha aceptado los permisos de notificaci√≥n");
      showMessage(`El contacto ${contactNumber} no ha aceptado permisos`, 'red');
      return;
    }
    
    const contactData = contactDoc.data();
    const fcmToken = contactData.fcmToken;
    
    if (!fcmToken) {
      console.log("‚ùå No hay token FCM disponible para este contacto");
      showMessage("Token FCM no disponible", 'red');
      return;
    }
    
    console.log("üîë Token FCM encontrado:", fcmToken);
    
    // 3. Enviar notificaci√≥n usando Firebase Cloud Messaging
    const response = await fetch('https://fcm.googleapis.com/fcm/send', {
      method: 'POST',
      headers: {
        'Authorization': 'key=AAAAj8V8xr4:APA91bGLkzx584S640fgWC9ZNlYjl4uoziGX3OhYScq5Atr2qCaer1YEVl1xL-ScvzMqX3SXDde5mmj2QXzlCM6AWkN5MVnjfRdxsRcgwm9g_icdJ_T5GqQ',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        to: fcmToken,
        notification: {
          title: "üö® ALERTA M√âDICA BB-8",
          body: `Paciente ${profileData.firstName} ${profileData.lastName} tiene niveles cr√≠ticos: Ox√≠geno ${oxygen}%, Pulso ${pulse} bpm`,
          icon: "https://upload.wikimedia.org/wikipedia/commons/3/39/BB-8_Star_Wars_icon.png",
          click_action: "https://rodaslindsy0-debug.github.io/BB-8/",
          requireInteraction: true
        },
        data: {
          oxygen: oxygen.toString(),
          pulse: pulse.toString(),
          patientName: `${profileData.firstName} ${profileData.lastName}`,
          timestamp: new Date().toISOString()
        }
      })
    });
    
    if (response.ok) {
      console.log("‚úÖ Notificaci√≥n enviada exitosamente a:", contactNumber);
      showMessage(`¬°Alerta enviada a ${contactNumber}!`, 'green');
    } else {
      const errorText = await response.text();
      console.error("‚ùå Error enviando notificaci√≥n:", errorText);
      showMessage("Error enviando notificaci√≥n", 'red');
    }
    
  } catch (error) {
    console.error("‚ùå Error en sendEmergencyNotification:", error);
    showMessage("Error: " + error.message, 'red');
  }
}

/* --- VERIFICAR ALERTAS --- */
async function checkAlerts(oxygen, pulse) {
  let oxLow = oxygen < 92;
  let pulLow = pulse < 55;

  if(oxLow && pulLow){
    showFullAlert();
    // ENVIAR NOTIFICACI√ìN DE EMERGENCIA
    await sendEmergencyNotification(oxygen, pulse);
    return;
  }

  if(oxLow){
    showMessage("‚ö†Ô∏è Ox√≠geno bajo - Enviando alerta al contacto");
    speak("Alerta, niveles de ox√≠geno bajos");
    // ENVIAR NOTIFICACI√ìN DE OX√çGENO BAJO
    await sendEmergencyNotification(oxygen, pulse);
  }

  if(pulLow){
    showMessage("‚ö†Ô∏è Pulso bajo - Enviando alerta al contacto");
    speak("Alerta, latidos por minuto bajos");
    // ENVIAR NOTIFICACI√ìN DE PULSO BAJO
    await sendEmergencyNotification(oxygen, pulse);
  }
}

// Guardar registro
saveEntryBtn.addEventListener('click', async ()=>{
  if(!currentUser) return showMessage("Usuario no logueado");
  
  const oxygen = parseInt(oxygenInput.value);
  const pulse = parseInt(pulseInput.value);
  
  if(!oxygen || !pulse) {
    showMessage("Ingresa valores v√°lidos para ox√≠geno y pulso");
    return;
  }

  // Verificar y enviar alertas
  await checkAlerts(oxygen, pulse);

  const entry = {
    date: dateInput.value,
    time: timeInput.value,
    oxygen: oxygen,
    pulse: pulse,
    createdAt: serverTimestamp()
  };
  
  try{
    await addDoc(collection(db, 'users',currentUser.uid,'records'), entry);
    dateInput.value=''; timeInput.value=''; oxygenInput.value=''; pulseInput.value='';
    loadHistory();
    showMessage("Registro guardado correctamente", 'green');
  }catch(e){ showMessage("Error al guardar: "+e.message); }
});

// Cargar historial
async function loadHistory(){
  if(!currentUser) return;
  historyList.innerHTML='';
  const q = query(collection(db,'users',currentUser.uid,'records'), orderBy('createdAt','desc'));
  const snapshot = await getDocs(q);
  snapshot.forEach(doc=>{
    const d = doc.data();
    const div = document.createElement('div');
    div.style.borderBottom='1px solid #eee';
    div.style.padding='6px 0';
    div.textContent=`${d.date || '‚Äî'} ${d.time || '‚Äî'} ‚Äî Ox√≠geno: ${d.oxygen || '‚Äî'}% | Pulso: ${d.pulse || '‚Äî'} bpm`;
    historyList.appendChild(div);
  });
}

// Export CSV
exportBtn.addEventListener('click', async ()=>{
  if(!currentUser) return;
  const q = query(collection(db,'users',currentUser.uid,'records'), orderBy('createdAt','desc'));
  const snapshot = await getDocs(q);
  let csv='Fecha;Hora;Ox√≠geno;Pulso\n';
  snapshot.forEach(doc=>{
    const d = doc.data();
    csv+=`${d.date || ''};${d.time || ''};${d.oxygen || ''};${d.pulse || ''}\n`;
  });
  const blob = new Blob(["\uFEFF"+csv], {type:'text/csv;charset=utf-8;'});
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = 'historial.csv';
  link.click();
});

// Borrar todos
clearBtn.addEventListener('click', async ()=>{
  if(!currentUser) return;
  if(!confirm("¬øBorrar todos los registros?")) return;
  const q = query(collection(db,'users',currentUser.uid,'records'));
  const snapshot = await getDocs(q);
  const batch = writeBatch(db);
  snapshot.forEach(doc=> batch.delete(doc.ref));
  await batch.commit();
  loadHistory();
});

/* --- SISTEMA DE VOZ --- */
function speak(text){
  const msg = new SpeechSynthesisUtterance(text);
  msg.lang = "es-ES";
  speechSynthesis.speak(msg);
}

/* --- ALERTA A PANTALLA COMPLETA --- */
const fullAlert = document.createElement("div");
fullAlert.style.position = "fixed";
fullAlert.style.top = "0";
fullAlert.style.left = "0";
fullAlert.style.width = "100vw";
fullAlert.style.height = "100vh";
fullAlert.style.background = "rgba(255,0,0,0.9)";
fullAlert.style.color = "white";
fullAlert.style.display = "flex";
fullAlert.style.alignItems = "center";
fullAlert.style.justifyContent = "center";
fullAlert.style.fontSize = "38px";
fullAlert.style.fontWeight = "900";
fullAlert.style.zIndex = "999999";
fullAlert.style.textAlign = "center";
fullAlert.style.padding = "20px";
fullAlert.style.display = "none";
fullAlert.innerText = "ALERTA!! Niveles de ox√≠geno y pulso bajos";
document.body.appendChild(fullAlert);

function showFullAlert(){
  fullAlert.style.display = "flex";
  speak("¬°ALERTA! Niveles de ox√≠geno y pulso extremadamente bajos");
  setTimeout(()=> fullAlert.style.display="none", 6000);
}

/* --- GENERADOR AUTOM√ÅTICO DE LINK --- */
function generateShareLink(){
  if(!currentUser) return "";
  return `https://rodaslindsy0-debug.github.io/BB-8/2.html?user=${currentUser.uid}`;
}

/* --- COPIAR LINK --- */
document.getElementById("copyLinkBtn").addEventListener("click", ()=>{
  const input = document.getElementById("shareLink");
  input.select();
  input.setSelectionRange(0, 99999);
  navigator.clipboard.writeText(input.value);
  showMessage("Link copiado ‚úîÔ∏è", "green");
});
</script>

<style>
:root{--accent:#00b33c;--muted:#6b7280;}
html,body{height:100%;margin:0;font-family:Inter, Arial,sans-serif;}
.bg{min-height:100vh;display:flex;align-items:center;justify-content:center;position:relative;background:url('https://lumiere-a.akamaihd.net/v1/images/bb-8-main_72775463.jpeg?region=320%2C51%2C567%2C425auto=format&fit=crop&w=1600&q=80') no-repeat center center;background-size:cover;overflow:hidden;}
.bg::before{content:"";position:absolute;inset:0;backdrop-filter:blur(8px);background:rgba(0,0,0,0.25);z-index:0;}
#loginBox{position:relative;z-index:1;background:rgba(255,255,255,0.94);padding:28px;border-radius:16px;width:100%;max-width:420px;box-shadow:0 10px 40px rgba(0,0,0,0.22);display:flex;flex-direction:column;gap:12px;text-align:center;margin:20px;}
.logo{width:76px;height:76px;border-radius:12px;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,#FFA500,#FF8C00);color:white;font-weight:800;font-size:20px;margin:0 auto;}
.btn{padding:12px;border-radius:10px;border:0;width:100%;cursor:pointer;font-weight:700;}
.google{background:#1a73e8;color:white;}
.ghost{background:transparent;border:1px solid #e6eefc;}
#app{display:none;min-height:100vh;width:100%;display:flex;align-items:center;justify-content:center;padding:20px;box-sizing:border-box;}
.overlay{position:relative;z-index:1;width:100%;max-width:980px;background:rgba(255,255,255,0.92);padding:18px;border-radius:14px;display:grid;grid-template-columns:360px 1fr;gap:18px;box-shadow:0 10px 40px rgba(0,0,0,0.18);margin:0 auto;}
.left{padding:22px;display:flex;flex-direction:column;align-items:center;gap:10px;}
.panel{background:white;padding:14px;border-radius:10px;box-shadow:0 8px 20px rgba(0,0,0,0.06);}
@media(max-width:900px){.overlay{grid-template-columns:1fr;}.left{order:2;padding:16px;}}
</style>
</head>
<body>

<div class="bg" id="login">
  <div id="loginBox">
    <div class="logo">BB-8</div>
    <h2>Bienvenido</h2>
    <p style="color:var(--muted);">Ingresa para continuar o registra un usuario</p>

    <!-- NUEVOS CAMPOS -->
    <input id="firstNameInput" type="text" placeholder="Nombre" style="padding:10px;border-radius:10px;border:1px solid #ddd;width:100%;" />
    <input id="lastNameInput" type="text" placeholder="Apellido" style="padding:10px;border-radius:10px;border:1px solid #ddd;width:100%;" />
    <input id="ageInput" type="number" min="0" max="120" placeholder="Edad" style="padding:10px;border-radius:10px;border:1px solid #ddd;width:100%;" />
    <input id="contactInput" type="tel" placeholder="N√∫mero de contacto" style="padding:10px;border-radius:10px;border:1px solid #ddd;width:100%;" />

    <!-- CAMPOS EXISTENTES -->
    <input id="emailInput" type="email" placeholder="Correo" style="padding:10px;border-radius:10px;border:1px solid #ddd;width:100%;" />
    <input id="passInput" type="password" placeholder="Contrase√±a" style="padding:10px;border-radius:10px;border:1px solid #ddd;width:100%;" />

    <button class="btn ghost" id="loginEmail">Iniciar Sesi√≥n</button>
    <button class="btn ghost" id="registerEmail">Crear cuenta</button>
    <button class="btn google" id="googleBtn">Iniciar con Google</button>
  </div>
</div>

<div class="bg" id="app">
  <div class="overlay">
    <div class="left">
      <div class="logo">BB-8</div>
      <h2>BB-8</h2>
      <p style="color:var(--muted);">Control m√©dico</p>
      <b id="userName"></b>
      <p id="userEmail" style="color:var(--muted);margin:0;"></p>
      <button class="btn ghost" id="logout">Cerrar sesi√≥n</button>
    </div>
    <div class="right" style="display:flex;flex-direction:column;gap:14px;">
      <div style="display:flex;gap:12px;">
        <button class="btn ghost" id="navReg">Registro</button>
        <button class="btn ghost" id="navHist">Historial</button>
      </div>
      <div id="regPanel" class="panel">
        <h3>Ingresar Registro</h3>
        <div style="display:flex;gap:10px;flex-wrap:wrap;">
          <div style="flex:1;min-width:160px;">
            <label style="font-size:13px;color:var(--muted);">Fecha</label>
            <input id="dateInput" type="date" style="padding:10px;border-radius:8px;border:1px solid #e7eef6;width:100%;" />
          </div>
          <div style="width:140px;">
            <label style="font-size:13px;color:var(--muted);">Hora</label>
            <input id="timeInput" type="time" style="padding:10px;border-radius:8px;border:1px solid #e7eef6;width:100%;" />
          </div>
        </div>
        <div style="margin-top:10px;display:flex;gap:10px;align-items:center;">
          <div style="flex:1">
            <label style="font-size:13px;color:var(--muted);">Ox√≠geno (%)</label>
            <input id="oxygenInput" type="number" min="50" max="100" placeholder="98" style="padding:10px;border-radius:8px;border:1px solid #e7eef6;width:100%;" />
          </div>
          <div style="width:140px;">
            <label style="font-size:13px;color:var(--muted);">Pulso (bpm)</label>
            <input id="pulseInput" type="number" min="20" max="220" placeholder="72" style="padding:10px;border-radius:8px;border:1px solid #e7eef6;width:100%;" />
          </div>
        </div>
        <div style="margin-top:12px;display:flex;gap:10px;">
          <button id="saveEntry" class="btn google">Guardar registro</button>
          <button id="btnNow" class="btn ghost">Hora actual</button>
        </div>
        
        <div style="margin-top:12px;display:flex;gap:10px;align-items:center;">
          <input id="shareLink" type="text" placeholder="Link generado..." 
                 style="flex:1;padding:10px;border-radius:8px;border:1px solid #e7eef6;">
          <button id="copyLinkBtn" class="btn ghost">Copiar link</button>
        </div>
      </div>

      <div id="histPanel" class="panel" style="display:none;">
        <h3>Historial</h3>
        <div id="historyList" style="max-height:380px;overflow:auto;padding-right:6px;"></div>
        <div style="display:flex;gap:8px;margin-top:10px;">
          <button id="exportBtn" class="btn ghost">Exportar CSV</button>
          <button id="clearBtn" class="btn ghost">Borrar todos</button>
        </div>
      </div>
    </div>
  </div>
</div>

</body>
</html>




