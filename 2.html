<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>Permisos de Notificación</title>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getMessaging, getToken } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-messaging.js";

// Configuración Firebase
const firebaseConfig = {
  apiKey: "AIzaSyDH-Ii_v4nHkBv1-0exU7kvyrcK-vf0SnU",
  authDomain: "maicol-114de.firebaseapp.com",
  projectId: "maicol-114de",
  storageBucket: "maicol-114de.firebasestorage.app",
  messagingSenderId: "770237885252",
  appId: "1:770237885252:web:a4d98332eb4c74a4f30511",
  measurementId: "G-Z8V3X8W8G1"
};

// Inicializar Firebase
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const messaging = getMessaging(app);

// Obtener número de contacto de la URL
const params = new URLSearchParams(window.location.search);
const contactNumber = params.get('contact');

async function requestPermission() {
  try {
    const permission = await Notification.requestPermission();
    if(permission === 'granted'){
      const token = await getToken(messaging, { 
        vapidKey: "BFBpaotlwl5Zf8FWr2svEXl2XA3E53IWdHJAo1jcpRbBsxJuVjl6T4v1ZJn49lu8GX7M_q36Ms3WEJX4dlyW2Ug" 
      });
      await setDoc(doc(db, 'contacts', contactNumber), { fcmToken: token });
      document.getElementById('status').textContent = '✅ Permiso concedido y token guardado';
    } else {
      document.getElementById('status').textContent = '❌ Permiso denegado';
    }
  } catch(e) {
    console.error(e);
    document.getElementById('status').textContent = '❌ Error al solicitar permiso';
  }
}

document.getElementById('btnPermission').addEventListener('click', requestPermission);
</script>
</head>
<body style="font-family:Arial,sans-serif;padding:20px;text-align:center;">
<h2>Permisos de Notificación</h2>
<p>Para recibir alertas cuando el paciente tenga valores críticos, haz clic en el botón:</p>
<button id="btnPermission" style="padding:12px 20px;font-size:16px;">Permitir Notificaciones</button>
<p id="status" style="margin-top:12px;color:green;"></p>
</body>
</html>
